name: Acceptance Tests

on:
  workflow_dispatch:  # Allow manual trigger
  schedule:
    # Run weekly on Monday at 2 AM UTC to avoid rate limit issues
    - cron: '0 2 * * 1'

permissions:
  contents: read

jobs:
  acceptance:
    name: 'Run Acceptance Tests'
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check Out
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
          cache: true
          go-version: stable

      - name: Run Acceptance Tests
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          VT_VERBOSE: true
        run: |
          if [ -z "$VT_API_KEY" ]; then
            echo "::warning::VT_API_KEY secret is not set. Skipping acceptance tests."
            exit 0
          fi
          
          echo "Running acceptance tests against VirusTotal API..."
          go test -v -timeout 30m ./virustotal/acceptance/...

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: acceptance-test-results
          path: |
            coverage.txt
          retention-days: 7

      - name: Comment on Failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issue_number = context.issue.number;
            const run_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Acceptance Tests Failed',
              body: `The scheduled acceptance tests have failed.\n\nSee the [workflow run](${run_url}) for details.`,
              labels: ['bug', 'acceptance-tests']
            });
